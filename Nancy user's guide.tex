% Nancy User's Guide

\documentclass[english]{scrartcl}
\usepackage{babel,a4,newlfont,fancyvrb,copyrght}
\usepackage[utf8]{inputenc}

% Alter some default parameters for general typesetting
\frenchspacing

% New commands
\renewcommand{\copyrightyear}{2002--2007}

\begin{document}

\title{Nancy, the lazy web site builder\\User's guide}
\date{1st March 2007}
\author{Reuben Thomas}
\maketitle

\section{Introduction}

Nancy is a simple web site builder that glues together HTML and other fragments to make pages, and allows fragments to be specialised for particular pages. Fragments can be held in files or generated programmatically.

Nancy is a command-line tool, typically used interactively from a POSIX-like shell.

\section{Invocation}

Nancy takes three (or optionally four) arguments:

\begin{verbatim}
nancy SOURCE DESTINATION TEMPLATE [BRANCH]
\end{verbatim}

\noindent where \verb|SOURCE| is the directory that contains the source tree, \verb|DESTINATION| is the directory to which the resulting HTML pages will be written, \verb|TEMPLATE| is the name of the template file, and the optional \verb|BRANCH| gives the sub-directory of \verb|SOURCE| to process (if it is omitted, the entire source tree is processed).

If you supply the optional flag \verb|-list-files|, or \verb|-l|, the files read by nancy will be listed on standard error.

\section{Operation}
\label{operation}

Nancy produces the finished pages according to the following algorithm:

\begin{enumerate}
\item For each leaf directory of the source tree, start from that directory.
\item Set the initial text to \verb|$include{TEMPLATE}|.
\item Repeatedly scan the text for a command and replace it by its output, until no more commands are found.
\item Write out the resultant text to a file: for each directory \verb|SOURCE/LEAF_PATH| the output file is \verb|DESTINATION/LEAF_PATH.html|.
\end{enumerate}

The reason that only leaf directories correspond to pages is to ensure that every page can be specialised without affecting any other page. By convention, every non-leaf directory has an \verb|index| sub-directory, so that there are no ``missing'' URLs in the resulting site. Nancy warns if an \verb|index| directory is absent.

A command takes the form

\begin{verbatim}
$COMMAND{ARGUMENT, ...}
\end{verbatim}

Nancy recognises these commands:

\begin{description}
\SaveVerb{include}|$include{FILE}|
\item[\UseVerb{include}]Replace the command with the contents of the given file.
\SaveVerb{root}|$root{}|
\item[\UseVerb{root}]Replace the command with the relative URL from the page currently being constructed to the root of the site. This command facilitates relative linking for any intra-site link.
\SaveVerb{run}|$run{PROGRAM[, ARGUMENT, ...]}|
\item[\UseVerb{run}]Replace the command with the output of the given program. The command is run with the full path of the current fragment as the first argument, with any further arguments given in the command after that.
\end{description}

Only one guarantee is made about the order in which commands are processed: if one command is nested inside another, the inner command will be processed first. (Other than that, the order can only matter for |\verb|$run| commands; if you use them, you have to deal with this potential pitfall.)

To find the file \verb|FILE_PATH| specified by an \verb|$include| or \verb|$run| command, nancy proceeds thus:

\begin{enumerate}
\item Look in \verb|DIRECTORY/LEAF_PATH/FILE_PATH|.
\item If the file is not found, remove the final directory from \verb|LEAF_PATH| and try again, until \verb|LEAF_PATH| is empty.
\item Finally, try looking in \verb|DIRECTORY/FILE_PATH|.
\end{enumerate}

So, for example, if \verb|DIRECTORY| is \verb|/dir|, \verb|LEAF_PATH| is \verb|foo/bar/baz| and nancy is trying to find \verb|file.html|, it will try the following directories, in order:

\begin{enumerate}
\item \verb|/dir/foo/bar/baz/file.html|
\item \verb|/dir/foo/bar/file.html|
\item \verb|/dir/foo/file.html|
\item \verb|/dir/file.html|
\end{enumerate}

\section{Example}
% FIXME: add use of $root

Suppose a web site with the following page design, from top to bottom: logo, navigation menu, breadcrumb trail, page body.

Most of the elements are the same on each page, but the breadcrumb trail has to show the canonical path to each page, and the logo is bigger on the home page.

Suppose further that the web site has the following structure, where each line corresponds to a page:

\begin{itemize}
\item Home page
\item People
  \begin{itemize}
  \item Jo Bloggs
  \item Hilary Pilary
  \item \dots
  \end{itemize}
\item Places
  \begin{itemize}
  \item Vladivostok
  \item Timbuktu
  \item \dots
  \end{itemize}
\end{itemize}

The basic page template looks something like this:

\begin{verbatim}
<html>
  <link href="style.css" rel="stylesheet" type="text/css">
  <title>$include{title}</title>
  <body>
    <div class="logo">$include{logo.html}</div>
    <div class="menu">$include{menu.html}</div>
    <div class="breadcrumb">$include{breadcrumb.html}</div>
    <div class="main">$include{main.html}</div>
  </body>
</html>
\end{verbatim}

Making the menu an included file is not strictly necessary, but, as in programming, makes the HTML fragments easier to read. The pages will be laid out as follows:

\begin{itemize}
\item \verb|/|
  \begin{itemize}
  \item \verb|index.html|
  \item \verb|people/|
    \begin{itemize}
    \item \verb|index.html|
    \item \verb|jo_bloggs.html|
    \item \verb|hilary_pilary.html|
    \end{itemize}
  \item \verb|places/|
    \begin{itemize}
    \item \verb|index.html|
    \item \verb|vladivostok.html|
    \item \verb|timbuktu.html|
    \end{itemize}
  \end{itemize}
\end{itemize}

The corresponding source files will be laid out as follows. This may look a little confusing at first, but note the similarity to the HTML pages, and hold on for the explanation!

\begin{itemize}
\item \verb|source/|
  \begin{itemize}
  \item \verb|template.html| (the template shown above)
  \item \verb|menu.html|
  \item \verb|logo.html|
  \item \verb|breadcrumb.html|
  \item \verb|index/|
    \begin{itemize}
    \item \verb|main.html|
    \item \verb|logo.html|
    \end{itemize}
  \item \verb|people/|
    \begin{itemize}
    \item \verb|breadcrumb.html|
    \item \verb|index/|
      \begin{itemize}
      \item \verb|main.html|
      \end{itemize}
    \item \verb|jo_bloggs/|
      \begin{itemize}
      \item \verb|main.html|
      \end{itemize}
    \item \verb|hilary_pilary/|
      \begin{itemize}
      \item \verb|main.html|
      \end{itemize}
    \end{itemize}
  \item \verb|places/|
    \begin{itemize}
    \item \verb|breadcrumb.html|
    \item \verb|index/|
      \begin{itemize}
      \item \verb|main.html|
      \end{itemize}
    \item \verb|vladivostok/|
      \begin{itemize}
      \item \verb|main.html|
      \end{itemize}
    \item \verb|timbuktu/|
      \begin{itemize}
      \item \verb|main.html|
      \end{itemize}
    \end{itemize}
  \end{itemize}
\end{itemize}

We could have used a different file suffix for page fragments, but using \verb|.html| is not too confusing, and means that editors and other tools that might depend on the file suffix to treat the file properly don't need special attention.

Note that there is only one menu fragment (the main menu is the same for every page), while each section has its own breadcrumb trail (\verb|breadcrumb.html|), and each page has its own content (\verb|main.html|).

To build the site, nancy is invoked as:

\begin{verbatim}
nancy source template.html dest
\end{verbatim}

Now consider how nancy builds the page whose URL is \verb|vladivostok.html|. According to the rules given in Section~\ref{operation}, nancy will look first for files in \verb|source/places/vladivostok|, then in \verb|source/places|, and finally in \verb|source|. Hence, the actual list of files used to assemble the page is:

\begin{itemize}
\item \verb|source/template.html|
\item \verb|source/logo.html|
\item \verb|source/menu.html|
\item \verb|source/places/breadcrumb.html|
\item \verb|source/places/vladivostok/main.html|
\end{itemize}

For the site's index page, the file \verb|index/logo.html| will be used for the logo fragment, which can refer to the larger graphic desired.

This scheme, though simple, is surprisingly flexible; this simple example has covered all the standard techniques for nancy's use.

\end{document}

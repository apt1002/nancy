#!/bin/bash
# Tests for Nancy

set -e

TEST=./nancy-test

# One-tree test
${TEST} webpage-src \
     template.html \
     "index.html people/index.html people/adam.html people/eve.html" \
     webpage-expected

# Test with template on stdin
${TEST} webpage-src \
     - \
     "index.html people/index.html people/adam.html people/eve.html" \
     webpage-expected \
     webpage-src/template.html

# Test nested macro invocations
${TEST} nested-macro-src \
     template.txt \
     nested.txt \
     nested-macro-expected

# Two-tree test
rm -rf src-merged
mkdir src-merged
./mergetrees mergetrees-src:webpage-src src-merged
${TEST} src-merged \
     template.html \
     "index.html animals/index.html animals/adam.html animals/eve.html" \
     mergetrees-expected

# Failing executable test
( ${TEST} . \
     false.txt \
     dummy \
     false-expected && \
    printf "Test succeeded unexpectedly" ) || true

# Passing executable test
${TEST} . \
     true.txt \
     true \
     true-expected

# Ensure that macros aren't expanded in Nancy's argument macros
${TEST} . \
     path.txt \
     '$path.txt' \
     dollar-path-expected

# Test that $paste doesn't expand macros
${TEST} paste-src \
     paste.txt \
     paste \
     paste-expected

#!/bin/bash
# Tests for Nancy

set -e

# Run a test
function test() {
    local SRC=$1
    local DIRS=$2
    local PAGES=$3
    local EXPECTED=$4
    rm -rf dest
    NANCY_CMD="perl -wMDevel::SimpleTrace ../nancy --verbose --root $SRC template.html"
    for dir in $DIRS; do
        mkdir $dir
    done
    for page in $PAGES; do
        $NANCY_CMD $page > dest/$page
    done
    diff -Nur $EXPECTED dest || ( echo "Test in `$SRC' failed" && exit 1 )
}

# One-tree test
test src \
     "dest dest/people" \
     "index.html people/index.html people/adam.html people/eve.html" \
     expected

# Two-tree test
rm -rf src-merged
mkdir src-merged
./mergetrees src2:src src-merged
test src-merged \
     "dest dest/animals" \
     "index.html animals/index.html animals/adam.html animals/eve.html" \
     expected2
